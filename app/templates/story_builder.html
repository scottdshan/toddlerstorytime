{% extends "base.html" %}

{% block title %}Create a Story - Toddler Storyteller{% endblock %}

{% set active_page = 'builder' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <h1 class="text-center mb-4">Create a Bedtime Story</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">Story Builder</h3>
                    <button id="randomizeBtn" class="btn btn-secondary">
                        <i class="fas fa-random me-2"></i>Randomize
                    </button>
                </div>
                
                <form id="storyForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="childName" class="form-label">Child's Name</label>
                            <input type="text" class="form-control" id="childName" name="childName" value="Wesley">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="universe" class="form-label">Story Universe</label>
                            <select class="form-select" id="universe" name="universe" required>
                                <option value="" disabled selected>Select a universe</option>
                                <!-- Options will be populated via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="setting" class="form-label">Story Setting</label>
                            <select class="form-select" id="setting" name="setting" required>
                                <option value="" disabled selected>Select a setting</option>
                                <!-- Options will be populated via JavaScript -->
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="theme" class="form-label">Story Theme</label>
                            <select class="form-select" id="theme" name="theme" required>
                                <option value="" disabled selected>Select a theme</option>
                                <!-- Options will be populated via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Characters</label>
                        <div id="charactersContainer" class="border rounded p-3">
                            <!-- Character checkboxes will be populated via JavaScript -->
                            <div class="row" id="charactersList"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="storyLength" class="form-label">Story Length</label>
                            <select class="form-select" id="storyLength" name="storyLength" required>
                                <option value="" disabled selected>Select length</option>
                                <!-- Options will be populated via JavaScript -->
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="llmProvider" class="form-label">AI Provider</label>
                            <select class="form-select" id="llmProvider" name="llmProvider">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Claude</option>
                                <option value="azure">Azure OpenAI</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3" id="modelSelectContainer" style="display: none;">
                            <label for="modelSelect" class="form-label">Model</label>
                            <select class="form-select" id="modelSelect" name="model">
                                <!-- Will be populated dynamically based on provider -->
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ttsProvider" class="form-label">Voice Provider</label>
                            <select class="form-select" id="ttsProvider" name="ttsProvider">
                                <option value="elevenlabs">ElevenLabs</option>
                                <option value="amazon">Amazon Polly</option>
                                <option value="none">None (Testing)</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3" id="voiceSelectContainer">
                            <label for="voiceSelect" class="form-label">Voice</label>
                            <select class="form-select" id="voiceSelect" name="voice_id">
                                <option value="">Loading voices...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" id="generateBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-wand-magic-sparkles me-2"></i>Generate Story
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Story Result Container (Initially Hidden) -->
        <div id="storyResult" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h3 id="storyTitle" class="text-center mb-3"></h3>
                
                <div class="text-center mb-4">
                    <div id="audioPlayer" class="audio-player">
                        <!-- Keep the audio element but hide it visually -->
                        <audio id="storyAudio" style="display: none;"></audio>
                    </div>
                </div>
                
                <div id="storyText" class="story-text"></div>
                
                <div class="d-flex justify-content-center mt-4">
                    <button id="playLocallyBtn" class="btn btn-success me-2" style="display: none;">
                        <i class="fas fa-headphones me-2"></i>Play Locally
                    </button>
                    <button id="regenerateBtn" class="btn btn-secondary me-2">
                        <i class="fas fa-sync me-2"></i>Regenerate
                    </button>
                    <button id="playOnHaBtn" class="btn btn-info" style="display: none;">
                        <i class="fas fa-broadcast-tower me-2"></i>Play on Home Assistant
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator (Initially Hidden) -->
        <div id="loadingContainer" class="text-center my-5" style="display: none;">
            <div class="card p-5 pulse-animation">
                <h3>Creating Your Story</h3>
                <div class="progress mt-3 mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <p id="loadingMessage">Gathering story elements...</p>
            </div>
        </div>
        
        <!-- Home Assistant Player Selection Modal -->
        <div class="modal fade" id="haPlayerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Media Player</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="ha-player-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading media players...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Home Assistant Player Controls -->
        <div id="player-controls" class="fixed-bottom bg-light shadow-lg p-3 d-none">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i> Playing on Home Assistant</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="pause-resume-ha-btn" class="btn btn-primary">
                            <i class="fas fa-pause me-1"></i> Pause
                        </button>
                        <button id="close-player-btn" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times me-1"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the model options for different providers
        initializeModelOptions();
        
        // Load user preferences
        loadUserPreferences();
        
        // Add event listeners for provider changes
        document.getElementById('llmProvider').addEventListener('change', function() {
            updateModelOptions(this.value);
        });
        
        document.getElementById('ttsProvider').addEventListener('change', function() {
            loadVoices(this.value);
        });
        
        // Story settings
        const storySettings = {
            universes: [
                "Paw Patrol", "Disney Princess", "PJ Masks", "Bluey", 
                "Peppa Pig", "Cocomelon", "Toy Story", "Mickey Mouse Clubhouse", 
                "Sesame Street", "Original Fantasy World"
            ],
            settings: [
                "Bedtime", "Playground", "Beach", "Zoo", "Farm", "Space", 
                "Underwater", "Forest", "Jungle", "Mountains", "School", 
                "Doctor's Office", "Rainy Day", "Snowy Day", "Birthday Party"
            ],
            themes: [
                "Friendship", "Helping Others", "Trying New Things", "Facing Fears", 
                "Being Kind", "Learning New Skills", "Listening to Parents", "Sharing", 
                "Patience", "Being Brave", "Taking Turns", "Apologizing", "Gratitude",
                "Sleep Routine", "Morning Routine"
            ],
            characters: [
                "Wesley", "Mom", "Dad", "Chase", "Marshall", "Skye", "Rubble", 
                "Rocky", "Zuma", "Ryder", "Elsa", "Anna", "Olaf", "Mickey Mouse", 
                "Minnie Mouse", "Bluey", "Bingo", "Bandit", "Chilli"
            ],
            storyLengths: [
                "Very Short (2-3 minutes)", "Short (3-5 minutes)", 
                "Medium (5-7 minutes)", "Long (7-10 minutes)"
            ]
        };
        
        // Populate form dropdowns and character options
        function populateFormOptions() {
            // Populate universe dropdown
            const universeSelect = document.getElementById('universe');
            storySettings.universes.forEach(universe => {
                const option = document.createElement('option');
                option.value = universe;
                option.textContent = universe;
                universeSelect.appendChild(option);
            });
            
            // Populate setting dropdown
            const settingSelect = document.getElementById('setting');
            storySettings.settings.forEach(setting => {
                const option = document.createElement('option');
                option.value = setting;
                option.textContent = setting;
                settingSelect.appendChild(option);
            });
            
            // Populate theme dropdown
            const themeSelect = document.getElementById('theme');
            storySettings.themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme;
                option.textContent = theme;
                themeSelect.appendChild(option);
            });
            
            // Populate story length dropdown
            const lengthSelect = document.getElementById('storyLength');
            storySettings.storyLengths.forEach(length => {
                const option = document.createElement('option');
                option.value = length;
                option.textContent = length;
                lengthSelect.appendChild(option);
            });
            
            // Populate character checkboxes
            const charactersList = document.getElementById('charactersList');
            storySettings.characters.forEach((character, index) => {
                const charDiv = document.createElement('div');
                charDiv.className = 'col-md-4 mb-2';
                charDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input character-checkbox" type="checkbox" 
                               value="${character}" id="char${index}">
                        <label class="form-check-label" for="char${index}">
                            ${character}
                        </label>
                    </div>
                `;
                charactersList.appendChild(charDiv);
            });
            
            // Check the first 3 characters by default (including Wesley)
            for (let i = 0; i < 3 && i < storySettings.characters.length; i++) {
                document.getElementById(`char${i}`).checked = true;
            }
        }
        
        // Initialize form
        populateFormOptions();
        
        // Load available voices for the selected TTS provider
        loadVoices(document.getElementById('ttsProvider').value);
        
        // Form submission handler
        document.getElementById('storyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateStory(false);
        });
        
        // Randomize button handler
        document.getElementById('randomizeBtn').addEventListener('click', function() {
            generateStory(true);
        });
        
        // Regenerate button handler
        document.getElementById('regenerateBtn').addEventListener('click', function() {
            generateStory(false);
        });
        
        // Audio element ended event listener
        document.getElementById('storyAudio').addEventListener('ended', function() {
            showToast('Audio playback complete', 'info');
        });
        
        // Function to generate a story
        function generateStory(randomize) {
            // Get selected characters
            const selectedCharacters = [];
            document.querySelectorAll('.character-checkbox:checked').forEach(checkbox => {
                // Format each character as an object with character_name property
                selectedCharacters.push({ character_name: checkbox.value });
            });
            
            // Validate form
            if (!randomize) {
                const universe = document.getElementById('universe').value;
                const setting = document.getElementById('setting').value;
                const theme = document.getElementById('theme').value;
                const storyLength = document.getElementById('storyLength').value;
                
                if (!universe || !setting || !theme || !storyLength) {
                    showToast('Please fill in all required fields', 'danger');
                    return;
                }
                
                if (selectedCharacters.length === 0) {
                    showToast('Please select at least one character', 'danger');
                    return;
                }
            }
            
            // Show loading indicator
            document.getElementById('storyResult').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            
            // Simulate progress (since we can't know the actual progress)
            simulateProgress();
            
            // Prepare data
            const formData = {
                child_name: document.getElementById('childName').value,
                universe: document.getElementById('universe').value,
                setting: document.getElementById('setting').value,
                theme: document.getElementById('theme').value,
                story_length: document.getElementById('storyLength').value,
                characters: selectedCharacters, // Now contains objects with character_name property
                llm_provider: document.getElementById('llmProvider').value,
                tts_provider: document.getElementById('ttsProvider').value,
                voice_id: document.getElementById('voiceSelect').value,
                randomize: randomize
            };
            
            console.log('Sending story request:', formData);
            
            // Make API request
            fetch('/api/stories/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate story');
                }
                return response.json();
            })
            .then(data => {
                // Update form if randomized
                if (randomize) {
                    updateFormWithGeneratedData(data);
                }
                
                // Display the story
                displayStory(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingContainer').style.display = 'none';
                showToast('Failed to generate story: ' + error.message, 'danger');
            });
        }
        
        // Function to simulate progress
        function simulateProgress() {
            const progressBar = document.getElementById('progressBar');
            const loadingMessage = document.getElementById('loadingMessage');
            let progress = 0;
            
            const messages = [
                "Gathering story elements...",
                "Creating characters...",
                "Building the plot...",
                "Adding magic touches...",
                "Generating story text...",
                "Creating audio narration..."
            ];
            
            const interval = setInterval(() => {
                progress += 5;
                if (progress > 100) {
                    clearInterval(interval);
                    return;
                }
                
                progressBar.style.width = progress + '%';
                
                // Update loading message at certain points
                if (progress === 20) loadingMessage.textContent = messages[1];
                else if (progress === 40) loadingMessage.textContent = messages[2];
                else if (progress === 60) loadingMessage.textContent = messages[3];
                else if (progress === 75) loadingMessage.textContent = messages[4];
                else if (progress === 90) loadingMessage.textContent = messages[5];
            }, 500);
        }
        
        // Function to update the form with generated data
        function updateFormWithGeneratedData(data) {
            document.getElementById('universe').value = data.universe;
            document.getElementById('setting').value = data.setting;
            document.getElementById('theme').value = data.theme;
            document.getElementById('storyLength').value = data.story_length;
            
            // Reset character checkboxes
            document.querySelectorAll('.character-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Check the characters from the generated story
            data.characters.forEach(character => {
                document.querySelectorAll('.character-checkbox').forEach(checkbox => {
                    if (checkbox.value === character.character_name) {
                        checkbox.checked = true;
                    }
                });
            });
        }
        
        // Function to display the generated story
        function displayStory(data) {
            // Hide loading indicator
            document.getElementById('loadingContainer').style.display = 'none';
            
            // Extract title from story text (assuming first line is the title)
            let storyLines = data.story_text.split('\n');
            let title = storyLines[0].replace(/^#+ /, ''); // Remove Markdown heading syntax
            
            // Set story title
            document.getElementById('storyTitle').textContent = title;
            
            // Format story text with paragraphs
            const formattedText = data.story_text.replace(/\n\n/g, '<br><br>');
            document.getElementById('storyText').innerHTML = formattedText;
            
            // Store the story ID for Home Assistant playback
            window.currentStoryId = data.id;
            
            // Set audio source if available
            if (data.audio_path) {
                const audioElement = document.getElementById('storyAudio');
                // Fix the path handling - ensure it has the /static/ prefix
                const audioPath = data.audio_path.startsWith('/static/') 
                    ? data.audio_path 
                    : '/static/' + data.audio_path;
                
                audioElement.src = audioPath;
                console.log('Setting audio source to:', audioPath);
                audioElement.load();
                
                // Set up Play Locally button
                const playLocallyBtn = document.getElementById('playLocallyBtn');
                playLocallyBtn.style.display = 'inline-block';
                playLocallyBtn.onclick = function() {
                    // Use the global player instead of playing directly
                    playAudioGlobal(audioPath, title);
                };
                
                // Show the Home Assistant button if there's audio
                const playOnHaBtn = document.getElementById('playOnHaBtn');
                playOnHaBtn.style.display = 'inline-block';
                playOnHaBtn.onclick = function() {
                    openHaPlayerSelector();
                };
                
                // Remove autoplay - the user must click a button to play audio
            } else {
                // Hide buttons if no audio
                document.getElementById('playLocallyBtn').style.display = 'none';
                document.getElementById('playOnHaBtn').style.display = 'none';
            }
            
            // Show story result container
            document.getElementById('storyResult').style.display = 'block';
            
            // Scroll to the story result
            document.getElementById('storyResult').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to load user preferences from the server
        async function loadUserPreferences() {
            try {
                const response = await fetch('/api/preferences/');
                
                if (!response.ok) {
                    throw new Error('Failed to load preferences');
                }
                
                const preferences = await response.json();
                console.log('Loaded preferences:', preferences);
                
                // Apply preferences to form fields
                if (preferences) {
                    // Set child name
                    if (preferences.child_name) {
                        document.getElementById('childName').value = preferences.child_name;
                    }
                    
                    // Set favorite universe
                    if (preferences.favorite_universe) {
                        const universeSelect = document.getElementById('universe');
                        for (let i = 0; i < universeSelect.options.length; i++) {
                            if (universeSelect.options[i].value === preferences.favorite_universe) {
                                universeSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Set favorite setting
                    if (preferences.favorite_setting) {
                        const settingSelect = document.getElementById('setting');
                        for (let i = 0; i < settingSelect.options.length; i++) {
                            if (settingSelect.options[i].value === preferences.favorite_setting) {
                                settingSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Set favorite theme
                    if (preferences.favorite_theme) {
                        const themeSelect = document.getElementById('theme');
                        for (let i = 0; i < themeSelect.options.length; i++) {
                            if (themeSelect.options[i].value === preferences.favorite_theme) {
                                themeSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Set preferred story length
                    if (preferences.preferred_story_length) {
                        const lengthSelect = document.getElementById('storyLength');
                        for (let i = 0; i < lengthSelect.options.length; i++) {
                            if (lengthSelect.options[i].value === preferences.preferred_story_length) {
                                lengthSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Set LLM provider
                    if (preferences.llm_provider) {
                        const providerSelect = document.getElementById('llmProvider');
                        for (let i = 0; i < providerSelect.options.length; i++) {
                            if (providerSelect.options[i].value === preferences.llm_provider) {
                                providerSelect.selectedIndex = i;
                                updateModelOptions(preferences.llm_provider);
                                break;
                            }
                        }
                    }
                    
                    // Set TTS provider and load voices
                    if (preferences.tts_provider) {
                        const ttsSelect = document.getElementById('ttsProvider');
                        for (let i = 0; i < ttsSelect.options.length; i++) {
                            if (ttsSelect.options[i].value === preferences.tts_provider) {
                                ttsSelect.selectedIndex = i;
                                loadVoices(preferences.tts_provider, preferences.voice_id);
                                break;
                            }
                        }
                    } else {
                        // Load voices for the current selection if no preference
                        loadVoices(document.getElementById('ttsProvider').value);
                    }
                    
                    // Check the checkbox for the favorite character
                    if (preferences.favorite_character) {
                        const characterCheckboxes = document.querySelectorAll('input[name="character"]');
                        characterCheckboxes.forEach(checkbox => {
                            if (checkbox.value === preferences.favorite_character) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error loading preferences:', error);
                // Show error notification
                showToast('Error loading preferences: ' + error.message, 'danger');
            }
        }
        
        // Function to load voices for the selected TTS provider
        async function loadVoices(provider, selectedVoiceId = null) {
            const voiceContainer = document.getElementById('voiceSelectContainer');
            const voiceSelect = document.getElementById('voiceSelect');
            
            // Clear existing options
            voiceSelect.innerHTML = '';
            
            // If provider is 'none', hide the voice selector
            if (provider === 'none') {
                voiceContainer.style.display = 'none';
                return;
            } else {
                voiceContainer.style.display = 'block';
            }
            
            try {
                const response = await fetch(`/api/audio/voices?provider=${provider}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load voices');
                }
                
                const voices = await response.json();
                
                // Sort voices by name
                voices.sort((a, b) => {
                    return a.name.localeCompare(b.name);
                });
                
                // Add options for each voice
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id;
                    
                    // Format the display name with gender and language if available
                    let displayName = voice.name;
                    if (voice.gender || voice.language) {
                        displayName += ' (';
                        if (voice.gender) {
                            displayName += voice.gender;
                        }
                        if (voice.gender && voice.language) {
                            displayName += ', ';
                        }
                        if (voice.language) {
                            displayName += voice.language;
                        }
                        displayName += ')';
                    }
                    
                    option.textContent = displayName;
                    voiceSelect.appendChild(option);
                    
                    // Select the voice if it matches the saved preference
                    if (selectedVoiceId && voice.voice_id === selectedVoiceId) {
                        option.selected = true;
                    }
                });
                
            } catch (error) {
                console.error('Error loading voices:', error);
                // Show error notification
                showToast('Error loading voices: ' + error.message, 'danger');
            }
        }
        
        // Function to initialize the model options
        function initializeModelOptions() {
            // Define model options for different providers
            window.modelOptions = {
                openai: [
                    { value: "gpt-4o", label: "GPT-4o" },
                    { value: "gpt-4o-mini", label: "GPT-4o Mini" },
                ],
                anthropic: [
                    { value: "claude-3-opus-20240229", label: "Claude 3 Opus" },
                    { value: "claude-3-sonnet-20240229", label: "Claude 3 Sonnet" },
                    { value: "claude-3-haiku-20240307", label: "Claude 3 Haiku" }
                ],
                azure: [
                    { value: "aoai-sds-gpt4o-mini-global", label: "GPT-4o Mini" }
                    // Users will need to fill this in based on their Azure setup
                ]
            };
            
            // Trigger initial setup of model options
            updateModelOptions(document.getElementById('llmProvider').value);
        }
        
        // Function to update model options based on the selected provider
        function updateModelOptions(provider) {
            const modelContainer = document.getElementById('modelSelectContainer');
            const modelSelect = document.getElementById('modelSelect');
            
            // Clear existing options
            modelSelect.innerHTML = "";
            
            if (provider in window.modelOptions) {
                // Show model selector and populate with options
                modelContainer.style.display = 'block';
                
                window.modelOptions[provider].forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.value;
                    optElement.textContent = option.label;
                    modelSelect.appendChild(optElement);
                });
                
                // For Azure, show a field for deployment name
                if (provider === 'azure') {
                    // Placeholder for Azure-specific UI elements
                }
            } else {
                // Hide model selector
                modelContainer.style.display = 'none';
            }
        }
        
        // Home Assistant Integration
        let currentPlayingEntityId = null;
        let isPlaying = false;
        
        // Open Home Assistant player selector
        function openHaPlayerSelector() {
            if (!window.currentStoryId) {
                showToast('No story available to play', 'danger');
                return;
            }
            
            // Show the player selection modal
            const haPlayerModal = new bootstrap.Modal(document.getElementById('haPlayerModal'));
            haPlayerModal.show();
            
            // Load media players
            document.getElementById('ha-player-list').innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading media players...</p>
                </div>
            `;
            
            fetch('/api/integrations/home-assistant/media-players')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load media players');
                    }
                    return response.json();
                })
                .then(players => {
                    if (players.length === 0) {
                        document.getElementById('ha-player-list').innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i> No media players found in your Home Assistant instance.
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '<div class="list-group">';
                    players.forEach(player => {
                        // Show different styling based on player state
                        let stateClass = 'text-muted';
                        let stateIcon = 'fa-power-off';
                        
                        if (player.state === 'playing') {
                            stateClass = 'text-success';
                            stateIcon = 'fa-play';
                        } else if (player.state === 'paused') {
                            stateClass = 'text-warning';
                            stateIcon = 'fa-pause';
                        } else if (player.state === 'idle') {
                            stateClass = 'text-info';
                            stateIcon = 'fa-stop';
                        }
                        
                        html += `
                            <button class="list-group-item list-group-item-action player-select" data-entity-id="${player.entity_id}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-speaker me-2"></i>
                                        <strong>${player.name}</strong>
                                    </div>
                                    <div class="${stateClass}">
                                        <i class="fas ${stateIcon} me-1"></i>
                                        ${player.state}
                                    </div>
                                </div>
                            </button>
                        `;
                    });
                    html += '</div>';
                    
                    document.getElementById('ha-player-list').innerHTML = html;
                    
                    // Add event handler for player selection
                    document.querySelectorAll('.player-select').forEach(button => {
                        button.addEventListener('click', function() {
                            const entityId = this.getAttribute('data-entity-id');
                            playStoryOnHomeAssistant(window.currentStoryId, entityId);
                            bootstrap.Modal.getInstance(document.getElementById('haPlayerModal')).hide();
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading media players:', error);
                    document.getElementById('ha-player-list').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i> Error loading media players: ${error.message}
                        </div>
                    `;
                });
        }
        
        // Play story on Home Assistant
        function playStoryOnHomeAssistant(storyId, entityId) {
            const data = {
                story_id: storyId,
                entity_id: entityId
            };
            
            fetch('/api/integrations/home-assistant/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to play on Home Assistant');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Story is now playing on Home Assistant', 'success');
                    currentPlayingEntityId = entityId; // Store the entity ID
                    isPlaying = true; // Set playing state to true
                    updatePlayPauseButton(); // Update button state
                    document.getElementById('player-controls').classList.remove('d-none'); // Show player controls
                } else {
                    showToast('Failed to play story on Home Assistant', 'danger');
                }
            })
            .catch(error => {
                console.error('Error playing on Home Assistant:', error);
                showToast('Error: ' + error.message, 'danger');
            });
        }
        
        // Toggle play/pause state
        function togglePlayPause() {
            if (!currentPlayingEntityId) {
                showToast('No media is currently playing', 'warning');
                return;
            }
            
            if (isPlaying) {
                pauseMedia();
            } else {
                resumeMedia();
            }
        }
        
        // Pause media playback
        function pauseMedia() {
            if (!currentPlayingEntityId) return;
            
            const data = {
                entity_id: currentPlayingEntityId
            };
            
            fetch('/api/integrations/home-assistant/pause', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to pause media');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Media paused', 'info');
                    isPlaying = false;
                    updatePlayPauseButton();
                } else {
                    showToast('Failed to pause media', 'danger');
                }
            })
            .catch(error => {
                console.error('Error pausing media:', error);
                showToast('Error: ' + error.message, 'danger');
            });
        }
        
        // Resume media playback
        function resumeMedia() {
            if (!currentPlayingEntityId) return;
            
            const data = {
                entity_id: currentPlayingEntityId
            };
            
            fetch('/api/integrations/home-assistant/play_pause', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to resume media');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Media resumed', 'info');
                    isPlaying = true;
                    updatePlayPauseButton();
                } else {
                    showToast('Failed to resume media', 'danger');
                }
            })
            .catch(error => {
                console.error('Error resuming media:', error);
                showToast('Error: ' + error.message, 'danger');
            });
        }
        
        // Update the play/pause button based on current state
        function updatePlayPauseButton() {
            const button = document.getElementById('pause-resume-ha-btn');
            if (isPlaying) {
                button.innerHTML = '<i class="fas fa-pause me-1"></i> Pause';
            } else {
                button.innerHTML = '<i class="fas fa-play me-1"></i> Resume';
            }
        }
        
        // Close player controls and stop playback
        document.getElementById('close-player-btn').addEventListener('click', function() {
            if (currentPlayingEntityId) {
                pauseMedia();
            }
            document.getElementById('player-controls').classList.add('d-none');
            currentPlayingEntityId = null;
        });
        
        // Add pause/resume button functionality
        document.getElementById('pause-resume-ha-btn').addEventListener('click', togglePlayPause);
    });
</script>
{% endblock %}
